"use strict";function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),AssetLoader=function(){function AssetLoader(completionCallback){_classCallCheck(this,AssetLoader),this.completionCallback=completionCallback||function(){},this.loadCounter=0,this.readyCounter=0,this.assets={},this.audio=new(window.AudioContext||window.webkitAudioContext),this.imageTypes=[".png",".jpg",".gif"],this.objectTypes=[".txt","json"],this.audioTypes=[".wav",".mp3",".ogg"]}return _createClass(AssetLoader,[{key:"addImageTask",value:function(url,name){var that=this,i=new Image;i.src=url,i.onload=function(){that.readyCounter++,that.attemptCompletionCallback(that.completionCallback)},this.assets[this.deriveObjectName(url,name)]=i,this.loadCounter++}},{key:"addHttpTask",value:function(url,name){var r=new XMLHttpRequest,that=this;r.onreadystatechange=function(){4==r.readyState&&200==r.status&&(that.assets[that.deriveObjectName(url,name)]=JSON.parse(r.responseText),that.readyCounter++,that.attemptCompletionCallback(that.completionCallback))},r.overrideMimeType("application/json"),r.open("GET",url,!0),r.send(null),this.loadCounter++}},{key:"addBufferTask",value:function(url,name){var that=this,r=new XMLHttpRequest;r.responseType="arraybuffer",r.open("GET",url,!0),r.onload=function(){that.audio.decodeAudioData(r.response,function(buffer){that.assets[that.deriveObjectName(url,name)]=buffer,that.readyCounter++,that.attemptCompletionCallback(that.completionCallback)},function(){console.log("Error decoding audio")})},r.send(),this.loadCounter++}},{key:"addTaskList",value:function(url){var that=this,r=new XMLHttpRequest;r.onreadystatechange=function(){if(4==r.readyState&&200==r.status)for(var fileList=r.responseText.split("\n"),i=0;i<fileList.length;i++){var ext=-1==fileList[i].indexOf("\r")?fileList[i].slice(-4):fileList[i].slice(-5).slice(0,-1);-1!=that.imageTypes.indexOf(ext)&&that.addImageTask(fileList[i]),-1!=that.objectTypes.indexOf(ext)&&that.addHttpTask(fileList[i]),-1!=that.audioTypes.indexOf(ext)&&that.addBufferTask(fileList[i])}},r.overrideMimeType("application/json"),r.open("GET",url,!0),r.send(null)}},{key:"isReady",value:function(){return 0!=this.loadCounter&&this.readyCounter==this.loadCounter}},{key:"getProgress",value:function(){return 0!=this.loadCounter?this.readyCounter/this.loadCounter*100:0}},{key:"getAsset",value:function(name){return this.assets[name]}},{key:"attemptCompletionCallback",value:function(callback){this.readyCounter==this.loadCounter&&void 0!==callback&&callback()}},{key:"deriveObjectName",value:function(url,name){if(void 0===name){var f=url.slice(url.lastIndexOf("/")+1);return f.slice(0,f.indexOf("."))}return name}}]),AssetLoader}(),AudioManager=function(){function AudioManager(){_classCallCheck(this,AudioManager);try{this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.songsPlaying=[],this.masterVolume=this.audioContext.createGain(),this.musicVolume=this.audioContext.createGain(),this.musicVolume.connect(this.masterVolume),this.effectsVolume=this.audioContext.createGain(),this.effectsVolume.connect(this.masterVolume),this.masterVolume.connect(this.audioContext.destination)}catch(e){console.error(e)}}return _createClass(AudioManager,[{key:"setBackgroundMusic",value:function(buffer,loop){if(-1==this.songsPlaying.indexOf(buffer)){var that=this,source=this.audioContext.createBufferSource();source.buffer=buffer,source.loop=loop||!1,source.connect(this.musicVolume),source.start(),source.onended=function(){loop||that.songsPlaying.splice(that.songsPlaying.indexOf(buffer),1)},this.songsPlaying.push(buffer)}}},{key:"playSound",value:function(buffer,loop){var source=this.audioContext.createBufferSource();source.buffer=buffer,source.loop=loop||!1,source.connect(this.effectsVolume),source.start()}}]),AudioManager}(),Component=function Component(){_classCallCheck(this,Component),this.name=this.constructor.name},Position=function(_Component){function Position(x,y){_classCallCheck(this,Position);var _this=_possibleConstructorReturn(this,(Position.__proto__||Object.getPrototypeOf(Position)).call(this));return _this.x=x,_this.y=y,_this}return _inherits(Position,_Component),Position}(Component),Velocity=function(_Component2){function Velocity(x,y){_classCallCheck(this,Velocity);var _this2=_possibleConstructorReturn(this,(Velocity.__proto__||Object.getPrototypeOf(Velocity)).call(this));return _this2.x=x,_this2.y=y,_this2}return _inherits(Velocity,_Component2),Velocity}(Component),Label=function(_Component3){function Label(x,y,txt,options){_classCallCheck(this,Label);var _this3=_possibleConstructorReturn(this,(Label.__proto__||Object.getPrototypeOf(Label)).call(this));return _this3.x=x,_this3.y=y,_this3.txt=txt,_this3.color=options.color||"#000",_this3.font=options.font||"monospace",_this3}return _inherits(Label,_Component3),Label}(Component),Sprite=function(_Component4){function Sprite(spriteSource){_classCallCheck(this,Sprite);var _this4=_possibleConstructorReturn(this,(Sprite.__proto__||Object.getPrototypeOf(Sprite)).call(this));return _this4.spriteSource=spriteSource,_this4}return _inherits(Sprite,_Component4),Sprite}(Component),AnimatedSprite=function(_Component5){function AnimatedSprite(spriteSource,animationSheet,options){_classCallCheck(this,AnimatedSprite);var _this5=_possibleConstructorReturn(this,(AnimatedSprite.__proto__||Object.getPrototypeOf(AnimatedSprite)).call(this));if(_this5.spriteSource=spriteSource,_this5.animationSheet=animationSheet,void 0===options)var options={};return _this5.animationName=options.animationName||Object.keys(animationSheet)[0],_this5.scale=options.scale||1,_this5.loop=options.loop||!0,_this5.isPlaying=options.isPlaying||!0,_this5.currentFrame=0,_this5}return _inherits(AnimatedSprite,_Component5),AnimatedSprite}(Component),AudioSource=function(_Component6){function AudioSource(audioBuffer){_classCallCheck(this,AudioSource);var _this6=_possibleConstructorReturn(this,(AudioSource.__proto__||Object.getPrototypeOf(AudioSource)).call(this));return _this6.audioBuffer=audioBuffer,_this6}return _inherits(AudioSource,_Component6),AudioSource}(Component),Box=function(_Component7){function Box(width,height,fillStyle){_classCallCheck(this,Box);var _this7=_possibleConstructorReturn(this,(Box.__proto__||Object.getPrototypeOf(Box)).call(this));return _this7.width=width,_this7.height=height,_this7.fillStyle=fillStyle,_this7}return _inherits(Box,_Component7),Box}(Component),BoxCollider=function(_Component8){function BoxCollider(width,height){_classCallCheck(this,BoxCollider);var _this8=_possibleConstructorReturn(this,(BoxCollider.__proto__||Object.getPrototypeOf(BoxCollider)).call(this));return _this8.width=width,_this8.height=height,_this8}return _inherits(BoxCollider,_Component8),BoxCollider}(Component),InputMapping=function(_Component9){function InputMapping(mapping){_classCallCheck(this,InputMapping);var _this9=_possibleConstructorReturn(this,(InputMapping.__proto__||Object.getPrototypeOf(InputMapping)).call(this));_this9.mapping=mapping;for(var i=0;i<mapping.length;i++)_this9[mapping[i].name]=!1;return _this9}return _inherits(InputMapping,_Component9),InputMapping}(Component),Entity=function(){function Entity(){_classCallCheck(this,Entity),this.id=Entity.prototype.count,Entity.prototype.count++}return _createClass(Entity,[{key:"addComponent",value:function(component){this[component.name]=component}},{key:"removeComponent",value:function(componentName){delete this[componentName]}},{key:"hasComponent",value:function(componentName){return null!=this[componentName]}},{key:"hasComponents",value:function(componentArray){for(var len=componentArray.length,i=0;i<len;i++)if(!this.hasComponent(componentArray[i]))return!1;return!0}}]),Entity}();Entity.prototype.count=0;var Game=function(){function Game(canvasContext){function startSystem(){if(window.requestAnimationFrame(startSystem),now=Date.now(),(delta=now-then)>interval||0==that.fps){if(then=now-delta%interval,!that.currentScene)return;for(var e in that.currentScene.gameEntities)for(var s in that.currentScene.systems){var entity=that.currentScene.gameEntities[e],system=that.currentScene.systems[s];entity.hasComponents(system.requiredComponents)&&that.currentScene.systems[s].update.call(that.services,entity)}that.canvasContext.fillStyle="white",that.canvasContext.fillRect(0,0,that.canvasContext.canvas.width,that.canvasContext.canvas.height);var cur;for(var e in that.currentScene.gameEntities)if(cur=that.currentScene.gameEntities[e],cur.hasComponent("Box")&&cur.hasComponent("Position")&&(that.canvasContext.fillStyle=cur.Box.fillStyle,that.canvasContext.fillRect(cur.Position.x,cur.Position.y,cur.Box.width,cur.Box.height)),cur.hasComponent("Sprite")&&cur.hasComponent("Position")&&that.canvasContext.drawImage(cur.Sprite.spriteSource,cur.Position.x,cur.Position.y),cur.hasComponents(["AnimatedSprite","Position"])){var c=cur.AnimatedSprite,f=c.animationSheet[c.animationName];that.canvasContext.drawImage(c.spriteSource,f.startX+c.currentFrame*f.frameWidth,f.startY,f.frameWidth,f.frameHeight,cur.Position.x,cur.Position.y,f.frameWidth*c.scale,f.frameHeight*c.scale),c.isPlaying&&(c.currentFrame==f.frames-1?c.currentFrame=0:c.currentFrame++)}}}_classCallCheck(this,Game);var that=this;this.canvasContext=canvasContext,canvasContext.webkitImageSmoothingEnabled=!1,canvasContext.imageSmoothingEnabled=!1,this.services={},this.services.input=new InputManager,this.services.audio=new AudioManager,this.services.assets=new AssetLoader,this.services.game={switchToScene:this.switchToScene.bind(this)},this.gameScenes={},this.currentScene=null,this.sceneEntities={},this.sceneSystems={},this.fps=60,this.startRendering=function(fps){that.fps=fps||60,startSystem()};var now,delta,interval=1e3/this.fps,then=Date.now()}return _createClass(Game,[{key:"addScene",value:function(scene){this.gameScenes[scene.sceneId]=scene,Object.assign(this.gameScenes[scene.sceneId],this.services),null==this.currentScene&&this.switchToScene(scene.sceneId)}},{key:"switchToScene",value:function(sceneId){null!=this.gameScenes[sceneId]?(this.currentScene=this.gameScenes[sceneId],this.currentScene.initialized&&!this.currentScene.alwaysInitialize||this.currentScene.initCallback()):console.error("Scene doesn't exist: "+sceneId)}},{key:"setDebugMode",value:function(isDebug){Game.prototype.debugMode=isDebug}},{key:"getDebugMode",value:function(){return Game.prototype.debugMode}},{key:"log",value:function(message){Game.prototype.debugMode&&console.log(message)}}]),Game}();Game.prototype.debugMode=!1;var InputManager=function(){function InputManager(){_classCallCheck(this,InputManager);var that=this;this.pressedKeys=[],window.addEventListener("keydown",function(e){-1===that.pressedKeys.indexOf(e.keyCode)&&that.pressedKeys.push(e.keyCode)},!1),window.addEventListener("keyup",function(e){that.pressedKeys.splice(that.pressedKeys.indexOf(e.keyCode),1)},!1)}return _createClass(InputManager,[{key:"isPressed",value:function(key){return-1!==this.pressedKeys.indexOf(key)}}]),InputManager}(),SystemScope={LOCAL:"local",GLOBAL:"global"},SystemType={RENDER:"render",NONRENDER:"nonrender"},Scene=function(){function Scene(options){_classCallCheck(this,Scene),this.sceneId=options.sceneId||"defaultScene",this.initialized=!1,this.initCallback=options.init||function(){},this.alwaysInitialize=options.alwaysInitialize||!0,this.systemScope=options.scope||SystemScope.LOCAL,this.systemType=options.type||SystemType.NONRENDER,this.gameEntities={},this.systems={}}return _createClass(Scene,[{key:"registerSystem",value:function(system){this.systems[system.systemId]=system}},{key:"unregisterSystem",value:function(system){delete this.systems[system.systemId]}},{key:"addEntity",value:function(entity){this.gameEntities[entity.id]=entity}}]),Scene}(),InputMappingSystem={systemId:"inputMappingSystem",requiredComponents:["InputMapping"],update:function(entity){for(var l=entity.InputMapping.mapping.length,i=0;i<l;i++){var c=entity.InputMapping.mapping[i];entity.InputMapping[c.name]=this.input.isPressed(c.code)}}};